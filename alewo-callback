#!/bin/bash

#######################################
# AlewoCallback - Professional CLI Manager
# Usage: alewo-callback {start|stop|restart|status|logs|help}
#######################################

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Configuration
INSTALL_DIR="/var/www/alewo-callback"
PID_DIR="$INSTALL_DIR/.pids"
LOG_DIR="$INSTALL_DIR/logs"
LOCK_FILE="$INSTALL_DIR/.lock"

# PID Files
HTTP_PID_FILE="$PID_DIR/http.pid"
MONGO_PID_FILE="$PID_DIR/mongo.pid"

# Log Files
HTTP_LOG="$LOG_DIR/http.log"
ERROR_LOG="$LOG_DIR/error.log"
STARTUP_LOG="$LOG_DIR/startup.log"

# Load environment variables
if [ -f "$INSTALL_DIR/.env" ]; then
    export $(cat "$INSTALL_DIR/.env" | grep -v '^#' | xargs 2>/dev/null)
fi

# Default values
HTTP_PORT=${PORT:-3000}
DNS_PORT=${DNS_PORT:-53}
NODE_ENV=${NODE_ENV:-production}

#######################################
# Logging Functions
#######################################

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
    [ -d "$LOG_DIR" ] && echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] $1" >> "$STARTUP_LOG"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
    [ -d "$LOG_DIR" ] && echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SUCCESS] $1" >> "$STARTUP_LOG"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
    [ -d "$LOG_DIR" ] && echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] $1" >> "$ERROR_LOG"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
    [ -d "$LOG_DIR" ] && echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARNING] $1" >> "$STARTUP_LOG"
}

#######################################
# Banner
#######################################

show_banner() {
    clear
    echo -e "${CYAN}"
    echo "╔═══════════════════════════════════════════════════════════╗"
    echo "║                                                           ║"
    echo "║        █████╗ ██╗     ███████╗██╗    ██╗ ██████╗         ║"
    echo "║       ██╔══██╗██║     ██╔════╝██║    ██║██╔═══██╗        ║"
    echo "║       ███████║██║     █████╗  ██║ █╗ ██║██║   ██║        ║"
    echo "║       ██╔══██║██║     ██╔══╝  ██║███╗██║██║   ██║        ║"
    echo "║       ██║  ██║███████╗███████╗╚███╔███╔╝╚██████╔╝        ║"
    echo "║       ╚═╝  ╚═╝╚══════╝╚══════╝ ╚══╝╚══╝  ╚═════╝         ║"
    echo "║                                                           ║"
    echo "║              CALLBACK SERVICE MANAGER                    ║"
    echo "║                                                           ║"
    echo "╚═══════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

#######################################
# Utility Functions
#######################################

setup_directories() {
    mkdir -p "$PID_DIR" "$LOG_DIR" 2>/dev/null || true
    chmod 755 "$PID_DIR" "$LOG_DIR" 2>/dev/null || true
}

is_running() {
    local pid_file=$1
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if ps -p "$pid" > /dev/null 2>&1; then
            return 0
        else
            rm -f "$pid_file" 2>/dev/null || true
            return 1
        fi
    fi
    return 1
}

check_port() {
    local port=$1
    if command -v netstat &> /dev/null; then
        netstat -tuln | grep -q ":$port "
    elif command -v ss &> /dev/null; then
        ss -tuln | grep -q ":$port "
    else
        return 1
    fi
}

get_uptime() {
    local pid_file=$1
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if ps -p "$pid" > /dev/null 2>&1; then
            ps -p "$pid" -o etime= | xargs
        else
            echo "Not running"
        fi
    else
        echo "Not running"
    fi
}

#######################################
# START Command
#######################################

cmd_start() {
    show_banner
    log_info "Starting AlewoCallback services..."

    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        log_error "This command must be run as root (use sudo)"
        exit 1
    fi

    # Setup directories
    setup_directories

    # Check if already running
    if is_running "$HTTP_PID_FILE"; then
        log_warning "HTTP server is already running (PID: $(cat $HTTP_PID_FILE))"
        echo ""
        cmd_status
        exit 0
    fi

    # Check lock file
    if [ -f "$LOCK_FILE" ]; then
        log_warning "Lock file exists. Another instance may be starting."
        log_info "If you're sure no other instance is running, remove: $LOCK_FILE"
        exit 1
    fi

    # Create lock file
    touch "$LOCK_FILE"

    # Check MongoDB
    if ! systemctl is-active --quiet mongod 2>/dev/null; then
        log_info "Starting MongoDB..."
        systemctl start mongod
        sleep 2
    fi

    # Start HTTP Server (includes DNS server)
    log_info "Starting HTTP/HTTPS Server on port $HTTP_PORT..."
    log_info "Starting DNS Server on port $DNS_PORT..."

    cd "$INSTALL_DIR"

    # Start server in background
    NODE_ENV=$NODE_ENV nohup node server/index.js > "$HTTP_LOG" 2>&1 &
    local server_pid=$!
    echo $server_pid > "$HTTP_PID_FILE"

    # Wait and verify
    sleep 3

    if is_running "$HTTP_PID_FILE"; then
        # Health check
        local retries=0
        local max_retries=10
        local health_ok=false

        while [ $retries -lt $max_retries ]; do
            if curl -s -f "http://localhost:$HTTP_PORT/health" > /dev/null 2>&1; then
                health_ok=true
                break
            fi
            sleep 1
            ((retries++))
        done

        if [ "$health_ok" = true ]; then
            log_success "HTTP/HTTPS Server started successfully (PID: $server_pid)"
            log_success "DNS Server started successfully (embedded)"

            # Remove lock file
            rm -f "$LOCK_FILE"

            echo ""
            echo -e "${GREEN}╔═══════════════════════════════════════════════════════════╗${NC}"
            echo -e "${GREEN}║                   SERVICES STARTED                        ║${NC}"
            echo -e "${GREEN}╚═══════════════════════════════════════════════════════════╝${NC}"
            echo ""
            echo -e "  ${CYAN}HTTP/HTTPS:${NC} http://localhost:$HTTP_PORT"
            echo -e "  ${CYAN}DNS Server:${NC} Port $DNS_PORT (UDP)"
            echo -e "  ${CYAN}Environment:${NC} $NODE_ENV"
            echo -e "  ${CYAN}Base Domain:${NC} ${BASE_DOMAIN:-Not configured}"
            echo ""
            echo -e "${YELLOW}View logs:${NC} alewo-callback logs"
            echo -e "${YELLOW}Check status:${NC} alewo-callback status"
            echo ""
        else
            log_error "Health check failed. Check logs: $HTTP_LOG"
            rm -f "$LOCK_FILE"
            exit 1
        fi
    else
        log_error "Failed to start server. Check logs: $HTTP_LOG"
        rm -f "$LOCK_FILE"
        exit 1
    fi
}

#######################################
# STOP Command
#######################################

cmd_stop() {
    show_banner
    log_info "Stopping AlewoCallback services..."

    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        log_error "This command must be run as root (use sudo)"
        exit 1
    fi

    local stopped_count=0

    # Stop HTTP Server (includes DNS)
    if is_running "$HTTP_PID_FILE"; then
        local pid=$(cat "$HTTP_PID_FILE")
        log_info "Stopping HTTP/HTTPS Server (PID: $pid)..."

        # Try graceful shutdown first
        kill -TERM "$pid" 2>/dev/null || true
        sleep 2

        # Force kill if still running
        if ps -p "$pid" > /dev/null 2>&1; then
            log_warning "Forcing shutdown..."
            kill -KILL "$pid" 2>/dev/null || true
            sleep 1
        fi

        if ! ps -p "$pid" > /dev/null 2>&1; then
            log_success "HTTP/HTTPS Server stopped"
            log_success "DNS Server stopped (embedded)"
            rm -f "$HTTP_PID_FILE"
            ((stopped_count++))
        else
            log_error "Failed to stop HTTP server (PID: $pid)"
        fi
    else
        log_info "HTTP server is not running"
    fi

    # Clean up any remaining Node processes for this app
    pkill -f "node.*server/index.js" 2>/dev/null || true

    # Remove lock file
    rm -f "$LOCK_FILE"

    # Clean up stale PID files
    rm -f "$PID_DIR"/*.pid 2>/dev/null || true

    echo ""
    if [ $stopped_count -gt 0 ]; then
        echo -e "${GREEN}╔═══════════════════════════════════════════════════════════╗${NC}"
        echo -e "${GREEN}║                   SERVICES STOPPED                        ║${NC}"
        echo -e "${GREEN}╚═══════════════════════════════════════════════════════════╝${NC}"
    else
        echo -e "${YELLOW}No services were running${NC}"
    fi
    echo ""
}

#######################################
# RESTART Command
#######################################

cmd_restart() {
    log_info "Restarting AlewoCallback services..."
    cmd_stop
    sleep 2
    cmd_start
}

#######################################
# STATUS Command
#######################################

cmd_status() {
    show_banner

    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║                   SERVICE STATUS                          ║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
    echo ""

    # HTTP/HTTPS Server Status
    echo -e "${YELLOW}HTTP/HTTPS Server:${NC}"
    if is_running "$HTTP_PID_FILE"; then
        local pid=$(cat "$HTTP_PID_FILE")
        local uptime=$(get_uptime "$HTTP_PID_FILE")
        echo -e "  Status: ${GREEN}● Running${NC}"
        echo -e "  PID: $pid"
        echo -e "  Uptime: $uptime"
        echo -e "  Port: $HTTP_PORT"

        # Check if port is actually listening
        if check_port "$HTTP_PORT"; then
            echo -e "  Port Check: ${GREEN}✓ Listening${NC}"
        else
            echo -e "  Port Check: ${RED}✗ Not listening${NC}"
        fi
    else
        echo -e "  Status: ${RED}● Stopped${NC}"
    fi

    echo ""

    # DNS Server Status (embedded with HTTP)
    echo -e "${YELLOW}DNS Server:${NC}"
    if is_running "$HTTP_PID_FILE"; then
        echo -e "  Status: ${GREEN}● Running${NC} (embedded)"
        echo -e "  Port: $DNS_PORT (UDP)"

        if check_port "$DNS_PORT"; then
            echo -e "  Port Check: ${GREEN}✓ Listening${NC}"
        else
            echo -e "  Port Check: ${YELLOW}⚠ Cannot verify UDP${NC}"
        fi
    else
        echo -e "  Status: ${RED}● Stopped${NC}"
    fi

    echo ""

    # MongoDB Status
    echo -e "${YELLOW}MongoDB:${NC}"
    if systemctl is-active --quiet mongod 2>/dev/null; then
        echo -e "  Status: ${GREEN}● Running${NC}"
    else
        echo -e "  Status: ${RED}● Stopped${NC}"
    fi

    echo ""

    # Configuration
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║                   CONFIGURATION                           ║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "  ${YELLOW}Environment:${NC} ${NODE_ENV:-Not set}"
    echo -e "  ${YELLOW}HTTP Port:${NC} ${HTTP_PORT:-Not set}"
    echo -e "  ${YELLOW}DNS Port:${NC} ${DNS_PORT:-Not set}"
    echo -e "  ${YELLOW}Base Domain:${NC} ${BASE_DOMAIN:-Not set}"
    echo -e "  ${YELLOW}SSL Enabled:${NC} ${SSL_ENABLED:-false}"
    echo -e "  ${YELLOW}Install Dir:${NC} $INSTALL_DIR"

    echo ""

    # Quick stats
    if is_running "$HTTP_PID_FILE"; then
        echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
        echo -e "${CYAN}║                   QUICK STATS                             ║${NC}"
        echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
        echo ""

        # Log sizes
        if [ -f "$HTTP_LOG" ]; then
            local log_size=$(du -h "$HTTP_LOG" 2>/dev/null | cut -f1)
            echo -e "  ${YELLOW}HTTP Log Size:${NC} $log_size"
        fi

        if [ -f "$ERROR_LOG" ]; then
            local error_size=$(du -h "$ERROR_LOG" 2>/dev/null | cut -f1)
            echo -e "  ${YELLOW}Error Log Size:${NC} $error_size"
        fi

        echo ""
    fi
}

#######################################
# LOGS Command
#######################################

cmd_logs() {
    local follow=false
    local lines=50
    local log_type="http"

    # Parse options
    while [[ $# -gt 0 ]]; do
        case $1 in
            -f|--follow)
                follow=true
                shift
                ;;
            -n|--lines)
                lines="$2"
                shift 2
                ;;
            --error)
                log_type="error"
                shift
                ;;
            --startup)
                log_type="startup"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    # Select log file
    case $log_type in
        error)
            local log_file="$ERROR_LOG"
            local log_name="Error Log"
            ;;
        startup)
            local log_file="$STARTUP_LOG"
            local log_name="Startup Log"
            ;;
        *)
            local log_file="$HTTP_LOG"
            local log_name="HTTP Server Log"
            ;;
    esac

    if [ ! -f "$log_file" ]; then
        log_error "Log file not found: $log_file"
        exit 1
    fi

    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║  $log_name${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
    echo ""

    if [ "$follow" = true ]; then
        tail -f -n "$lines" "$log_file"
    else
        tail -n "$lines" "$log_file"
    fi
}

#######################################
# HELP Command
#######################################

cmd_help() {
    show_banner

    echo -e "${CYAN}USAGE:${NC}"
    echo -e "  alewo-callback ${YELLOW}<command>${NC} [options]"
    echo ""

    echo -e "${CYAN}COMMANDS:${NC}"
    echo -e "  ${GREEN}start${NC}                Start all services (HTTP, DNS, MongoDB)"
    echo -e "  ${GREEN}stop${NC}                 Stop all services"
    echo -e "  ${GREEN}restart${NC}              Restart all services"
    echo -e "  ${GREEN}status${NC}               Show service status and configuration"
    echo -e "  ${GREEN}logs${NC}                 Show service logs"
    echo -e "  ${GREEN}help${NC}                 Show this help message"
    echo ""

    echo -e "${CYAN}LOG OPTIONS:${NC}"
    echo -e "  alewo-callback logs ${YELLOW}[-f|--follow]${NC}      Follow log output"
    echo -e "  alewo-callback logs ${YELLOW}[-n|--lines N]${NC}     Show last N lines (default: 50)"
    echo -e "  alewo-callback logs ${YELLOW}[--error]${NC}          Show error log"
    echo -e "  alewo-callback logs ${YELLOW}[--startup]${NC}        Show startup log"
    echo ""

    echo -e "${CYAN}EXAMPLES:${NC}"
    echo -e "  sudo alewo-callback start              # Start all services"
    echo -e "  sudo alewo-callback stop               # Stop all services"
    echo -e "  sudo alewo-callback restart            # Restart services"
    echo -e "  alewo-callback status                  # Check status (no sudo needed)"
    echo -e "  alewo-callback logs -f                 # Follow live logs"
    echo -e "  alewo-callback logs --error -n 100     # Show last 100 error lines"
    echo ""

    echo -e "${CYAN}NOTES:${NC}"
    echo -e "  • ${YELLOW}start/stop/restart${NC} commands require sudo/root"
    echo -e "  • ${YELLOW}status/logs${NC} commands can run without root"
    echo -e "  • DNS server runs on port 53 (embedded with HTTP server)"
    echo -e "  • Logs are stored in: $LOG_DIR"
    echo -e "  • PID files are in: $PID_DIR"
    echo ""
}

#######################################
# MAIN
#######################################

main() {
    local command="${1:-help}"

    case "$command" in
        start)
            cmd_start
            ;;
        stop)
            cmd_stop
            ;;
        restart)
            cmd_restart
            ;;
        status)
            cmd_status
            ;;
        logs)
            shift
            cmd_logs "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            echo -e "${RED}Error: Unknown command '$command'${NC}"
            echo ""
            echo "Run 'alewo-callback help' for usage information"
            exit 1
            ;;
    esac
}

# Run main
main "$@"
