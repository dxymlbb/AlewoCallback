#!/bin/bash

#######################################
# AlewoCallback - Professional CLI Manager
# Usage: alewo-callback {start|stop|restart|status|logs|help}
#######################################

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Configuration
INSTALL_DIR="/var/www/alewo-callback"
APP_NAME="alewo-callback"

# Find PM2 and Node.js binaries
find_node_binaries() {
    # Try common locations
    local NODE_DIRS=(
        "/opt/node22"
        "/opt/node20"
        "/opt/node18"
        "/usr/local"
        "/usr"
    )

    for dir in "${NODE_DIRS[@]}"; do
        if [ -f "$dir/bin/pm2" ]; then
            export NODE_BIN="$dir/bin/node"
            export PM2_BIN="$dir/bin/pm2"
            export NPM_BIN="$dir/bin/npm"
            export PATH="$dir/bin:$PATH"
            return 0
        fi
    done

    # Fallback to PATH
    if command -v pm2 &>/dev/null; then
        export PM2_BIN=$(command -v pm2)
        export NODE_BIN=$(command -v node)
        export NPM_BIN=$(command -v npm)
        return 0
    fi

    return 1
}

# Initialize binaries
if ! find_node_binaries; then
    echo -e "${RED}[ERROR]${NC} PM2 not found. Please install PM2 first."
    echo "Run: npm install -g pm2"
    exit 1
fi

# Load environment variables
if [ -f "$INSTALL_DIR/.env" ]; then
    export $(cat "$INSTALL_DIR/.env" | grep -v '^#' | xargs 2>/dev/null)
fi

# Default values
HTTP_PORT=${PORT:-3000}
DNS_PORT=${DNS_PORT:-53}
NODE_ENV=${NODE_ENV:-production}
BASE_DOMAIN=${BASE_DOMAIN:-localhost}

#######################################
# Logging Functions
#######################################

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

#######################################
# Banner
#######################################

show_banner() {
    clear
    echo -e "${CYAN}"
    echo "╔═══════════════════════════════════════════════════════════╗"
    echo "║                                                           ║"
    echo "║        █████╗ ██╗     ███████╗██╗    ██╗ ██████╗         ║"
    echo "║       ██╔══██╗██║     ██╔════╝██║    ██║██╔═══██╗        ║"
    echo "║       ███████║██║     █████╗  ██║ █╗ ██║██║   ██║        ║"
    echo "║       ██╔══██║██║     ██╔══╝  ██║███╗██║██║   ██║        ║"
    echo "║       ██║  ██║███████╗███████╗╚███╔███╔╝╚██████╔╝        ║"
    echo "║       ╚═╝  ╚═╝╚══════╝╚══════╝ ╚══╝╚══╝  ╚═════╝         ║"
    echo "║                                                           ║"
    echo "║              CALLBACK SERVICE MANAGER                    ║"
    echo "║                                                           ║"
    echo "╚═══════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
    echo ""
}

#######################################
# Helper Functions
#######################################

# Check if PM2 process is running
is_pm2_running() {
    if "$PM2_BIN" describe "$APP_NAME" > /dev/null 2>&1; then
        local status=$("$PM2_BIN" jlist 2>/dev/null | grep -o "\"name\":\"$APP_NAME\"[^}]*\"status\":\"[^\"]*\"" | grep -o 'status":"[^"]*"' | cut -d'"' -f3)
        if [ "$status" = "online" ]; then
            return 0
        fi
    fi
    return 1
}

# Get PM2 process uptime (returns uptime in milliseconds)
get_pm2_uptime() {
    # pm_uptime is a timestamp, not duration - need to calculate difference
    local pm_uptime_timestamp=$("$PM2_BIN" jlist 2>/dev/null | grep -o "\"name\":\"$APP_NAME\"[^}]*\"pm_uptime\":[^,]*" | grep -o 'pm_uptime":[0-9]*' | cut -d':' -f2)

    if [ -z "$pm_uptime_timestamp" ] || [ "$pm_uptime_timestamp" = "0" ]; then
        echo "0"
        return
    fi

    # Get current time in milliseconds
    local current_time_ms=$(date +%s%3N)

    # Calculate uptime duration
    local uptime_duration=$((current_time_ms - pm_uptime_timestamp))

    echo "$uptime_duration"
}

# Format uptime
format_uptime() {
    local uptime_ms=$1
    if [ -z "$uptime_ms" ] || [ "$uptime_ms" = "0" ] || [ "$uptime_ms" -lt "0" ]; then
        echo "just started"
        return
    fi
    local uptime_sec=$((uptime_ms / 1000))
    local days=$((uptime_sec / 86400))
    local hours=$(((uptime_sec % 86400) / 3600))
    local minutes=$(((uptime_sec % 3600) / 60))

    if [ $days -gt 0 ]; then
        echo "${days}d ${hours}h ${minutes}m"
    elif [ $hours -gt 0 ]; then
        echo "${hours}h ${minutes}m"
    else
        echo "${minutes}m"
    fi
}

# Check if port is listening (supports both TCP and UDP)
check_port() {
    local port=$1
    local protocol=${2:-tcp}  # default to tcp if not specified

    if [ "$protocol" = "udp" ]; then
        # Check UDP port (for DNS)
        if command -v ss &>/dev/null; then
            ss -ulnp 2>/dev/null | grep -q ":$port " && return 0
        elif command -v netstat &>/dev/null; then
            netstat -ulnp 2>/dev/null | grep -q ":$port " && return 0
        elif command -v lsof &>/dev/null; then
            lsof -Pi :$port -sUDP 2>/dev/null | grep -q "LISTEN\|UDP" && return 0
        fi
    else
        # Check TCP port (for HTTP/HTTPS)
        if command -v ss &>/dev/null; then
            ss -tlnp 2>/dev/null | grep -q ":$port " && return 0
        elif command -v netstat &>/dev/null; then
            netstat -tlnp 2>/dev/null | grep -q ":$port " && return 0
        elif command -v lsof &>/dev/null; then
            lsof -Pi :$port -sTCP:LISTEN 2>/dev/null | grep -q "LISTEN" && return 0
        fi
    fi

    return 1
}

#######################################
# START Command
#######################################

cmd_start() {
    show_banner
    log_info "Starting AlewoCallback services..."
    echo ""

    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        log_error "This command must be run as root (use sudo)"
        exit 1
    fi

    # Check if already running
    if is_pm2_running; then
        log_warning "Application is already running"
        echo ""
        cmd_status
        exit 0
    fi

    # Check MongoDB
    if ! systemctl is-active --quiet mongod 2>/dev/null && ! systemctl is-active --quiet mongodb 2>/dev/null; then
        log_info "Starting MongoDB..."
        systemctl start mongod 2>/dev/null || systemctl start mongodb 2>/dev/null
        sleep 2
    fi

    # Start with PM2
    log_info "Starting HTTP/HTTPS Server on port $HTTP_PORT..."
    log_info "Starting DNS Server on port $DNS_PORT..."
    echo ""

    cd "$INSTALL_DIR"

    # Start application with PM2
    "$PM2_BIN" start server/index.js --name "$APP_NAME" > /dev/null 2>&1

    # Wait for startup
    sleep 3

    # Verify startup
    if is_pm2_running; then
        # Health check
        local retries=0
        local max_retries=10
        local health_ok=false

        while [ $retries -lt $max_retries ]; do
            if curl -s -f "http://localhost:$HTTP_PORT/health" > /dev/null 2>&1; then
                health_ok=true
                break
            fi
            sleep 1
            ((retries++))
        done

        if [ "$health_ok" = true ]; then
            log_success "HTTP/HTTPS Server started successfully"
            log_success "DNS Server started successfully"

            echo ""
            echo -e "${GREEN}╔═══════════════════════════════════════════════════════════╗${NC}"
            echo -e "${GREEN}║                   SERVICES STARTED                        ║${NC}"
            echo -e "${GREEN}╚═══════════════════════════════════════════════════════════╝${NC}"
            echo ""
            echo -e "  ${CYAN}HTTP/HTTPS:${NC} http://localhost:$HTTP_PORT"
            echo -e "  ${CYAN}DNS Server:${NC} Port $DNS_PORT (UDP)"
            echo -e "  ${CYAN}Environment:${NC} $NODE_ENV"
            echo -e "  ${CYAN}Base Domain:${NC} ${BASE_DOMAIN}"
            echo ""
            echo -e "${YELLOW}Commands:${NC}"
            echo -e "  alewo-callback status  - Check service status"
            echo -e "  alewo-callback logs -f - Follow logs in real-time"
            echo ""
        else
            log_error "Service started but health check failed"
            log_info "Check logs: alewo-callback logs"
            exit 1
        fi
    else
        log_error "Failed to start service"
        log_info "Check logs: alewo-callback logs"
        exit 1
    fi
}

#######################################
# STOP Command
#######################################

cmd_stop() {
    show_banner
    log_info "Stopping AlewoCallback services..."
    echo ""

    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        log_error "This command must be run as root (use sudo)"
        exit 1
    fi

    # Check if running
    if ! is_pm2_running; then
        log_info "Services are not running"
        exit 0
    fi

    # Stop via PM2
    log_info "Stopping HTTP/HTTPS Server..."
    log_info "Stopping DNS Server..."
    echo ""

    "$PM2_BIN" stop "$APP_NAME" > /dev/null 2>&1

    # Verify stopped
    if ! is_pm2_running; then
        log_success "HTTP/HTTPS Server stopped"
        log_success "DNS Server stopped"

        echo ""
        echo -e "${GREEN}╔═══════════════════════════════════════════════════════════╗${NC}"
        echo -e "${GREEN}║                   SERVICES STOPPED                        ║${NC}"
        echo -e "${GREEN}╚═══════════════════════════════════════════════════════════╝${NC}"
        echo ""
    else
        log_error "Failed to stop services"
        exit 1
    fi
}

#######################################
# RESTART Command
#######################################

cmd_restart() {
    show_banner
    log_info "Restarting AlewoCallback services..."
    echo ""

    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        log_error "This command must be run as root (use sudo)"
        exit 1
    fi

    # Sync latest code from repository to installation directory
    if [ -d "/home/user/AlewoCallback" ]; then
        log_info "Syncing latest code to installation directory..."

        # Copy server files
        cp -r /home/user/AlewoCallback/server/* "$INSTALL_DIR/server/" 2>/dev/null || true

        # Copy client build
        if [ -d "/home/user/AlewoCallback/client/dist" ]; then
            cp -r /home/user/AlewoCallback/client/dist/* "$INSTALL_DIR/client/dist/" 2>/dev/null || true
        fi

        # Copy package files
        cp /home/user/AlewoCallback/package.json "$INSTALL_DIR/" 2>/dev/null || true
        cp /home/user/AlewoCallback/.env "$INSTALL_DIR/" 2>/dev/null || true

        log_success "Code synced successfully"
    fi

    # Restart via PM2
    if is_pm2_running; then
        log_info "Restarting HTTP/HTTPS Server..."
        log_info "Restarting DNS Server..."
        echo ""

        "$PM2_BIN" restart "$APP_NAME" > /dev/null 2>&1
        sleep 2

        if is_pm2_running; then
            log_success "Services restarted successfully"
            echo ""
            cmd_status
        else
            log_error "Failed to restart services"
            exit 1
        fi
    else
        log_warning "Services are not running. Starting instead..."
        cmd_start
    fi
}

#######################################
# STATUS Command
#######################################

cmd_status() {
    show_banner

    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║                   SERVICE STATUS                          ║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
    echo ""

    # HTTP/HTTPS Server Status
    echo -e "${YELLOW}HTTP/HTTPS Server:${NC}"
    if is_pm2_running; then
        local uptime_ms=$(get_pm2_uptime)
        local uptime=$(format_uptime $uptime_ms)

        echo -e "  Status: ${GREEN}● Running${NC}"
        echo -e "  Uptime: $uptime"
        echo -e "  Port: $HTTP_PORT"

        if check_port "$HTTP_PORT"; then
            echo -e "  Listening: ${GREEN}✓${NC}"
        else
            echo -e "  Listening: ${RED}✗${NC}"
        fi
    else
        echo -e "  Status: ${RED}● Stopped${NC}"
    fi

    echo ""

    # DNS Server Status
    echo -e "${YELLOW}DNS Server:${NC}"
    if is_pm2_running && check_port "$DNS_PORT" "udp"; then
        echo -e "  Status: ${GREEN}● Running${NC}"
        echo -e "  Port: $DNS_PORT (UDP)"
    else
        if is_pm2_running; then
            echo -e "  Status: ${YELLOW}● Process running, port check inconclusive${NC}"
            echo -e "  Port: $DNS_PORT (UDP)"
        else
            echo -e "  Status: ${RED}● Stopped${NC}"
        fi
    fi

    echo ""

    # MongoDB Status
    echo -e "${YELLOW}MongoDB:${NC}"
    if systemctl is-active --quiet mongod 2>/dev/null || systemctl is-active --quiet mongodb 2>/dev/null; then
        echo -e "  Status: ${GREEN}● Running${NC}"
    else
        echo -e "  Status: ${RED}● Stopped${NC}"
    fi

    echo ""

    # Configuration
    echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║                   CONFIGURATION                           ║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
    echo ""

    echo -e "  Environment: ${NODE_ENV}"
    echo -e "  HTTP Port: ${HTTP_PORT}"
    echo -e "  DNS Port: ${DNS_PORT}"
    echo -e "  Base Domain: ${BASE_DOMAIN}"
    echo -e "  SSL Enabled: ${SSL_ENABLED:-false}"
    echo -e "  Install Dir: ${INSTALL_DIR}"

    echo ""
}

#######################################
# LOGS Command
#######################################

cmd_logs() {
    local follow=false
    local lines=50
    local error_only=false

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -f|--follow)
                follow=true
                shift
                ;;
            -e|--error)
                error_only=true
                shift
                ;;
            -n|--lines)
                lines="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done

    # Show logs via PM2
    if [ "$follow" = true ]; then
        "$PM2_BIN" logs "$APP_NAME" --lines "$lines"
    elif [ "$error_only" = true ]; then
        "$PM2_BIN" logs "$APP_NAME" --err --lines "$lines" --nostream
    else
        "$PM2_BIN" logs "$APP_NAME" --lines "$lines" --nostream
    fi
}

#######################################
# UNINSTALL Command
#######################################

cmd_uninstall() {
    clear
    echo -e "${RED}"
    echo "╔═══════════════════════════════════════════════════════════╗"
    echo "║              ALEWO CALLBACK UNINSTALLER                  ║"
    echo "║              ⚠️  THIS WILL REMOVE ALL DATA  ⚠️            ║"
    echo "╚═══════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
    echo ""

    read -p "$(echo -e ${YELLOW}Are you sure you want to continue? ${NC}[y/N]: )" -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Uninstallation cancelled"
        exit 0
    fi

    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        log_error "This command must be run as root (use sudo)"
        exit 1
    fi

    log_info "Stopping services..."
    "$PM2_BIN" delete "$APP_NAME" 2>/dev/null || true
    "$PM2_BIN" kill 2>/dev/null || true

    log_info "Removing systemd services..."
    systemctl stop pm2-root 2>/dev/null || true
    systemctl disable pm2-root 2>/dev/null || true
    rm -f /etc/systemd/system/pm2-root.service

    log_info "Removing application files..."
    rm -rf "$INSTALL_DIR"

    log_info "Removing management command..."
    rm -f /usr/local/bin/alewo-callback

    log_info "Removing Nginx configuration..."
    rm -f /etc/nginx/sites-enabled/alewo-callback
    rm -f /etc/nginx/sites-available/alewo-callback
    systemctl reload nginx 2>/dev/null || true

    log_success "AlewoCallback has been uninstalled"
    echo ""
}

#######################################
# HELP Command
#######################################

cmd_help() {
    show_banner

    echo -e "${CYAN}USAGE:${NC}"
    echo -e "  alewo-callback [COMMAND] [OPTIONS]"
    echo ""
    echo -e "${CYAN}COMMANDS:${NC}"
    echo -e "  ${GREEN}start${NC}      Start all services (requires sudo)"
    echo -e "  ${GREEN}stop${NC}       Stop all services (requires sudo)"
    echo -e "  ${GREEN}restart${NC}    Restart all services (requires sudo)"
    echo -e "  ${GREEN}status${NC}     Show service status"
    echo -e "  ${GREEN}logs${NC}       View application logs"
    echo -e "  ${GREEN}uninstall${NC}  Remove AlewoCallback (requires sudo)"
    echo -e "  ${GREEN}help${NC}       Show this help message"
    echo ""
    echo -e "${CYAN}LOG OPTIONS:${NC}"
    echo -e "  ${YELLOW}-f, --follow${NC}     Follow log output in real-time"
    echo -e "  ${YELLOW}-e, --error${NC}      Show only error logs"
    echo -e "  ${YELLOW}-n, --lines N${NC}    Show last N lines (default: 50)"
    echo ""
    echo -e "${CYAN}EXAMPLES:${NC}"
    echo -e "  sudo alewo-callback start"
    echo -e "  alewo-callback status"
    echo -e "  alewo-callback logs -f"
    echo -e "  alewo-callback logs --error --lines 100"
    echo ""
}

#######################################
# Main
#######################################

# Parse command
case "${1:-help}" in
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    status)
        cmd_status
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    uninstall)
        cmd_uninstall
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        log_error "Unknown command: $1"
        echo ""
        cmd_help
        exit 1
        ;;
esac
